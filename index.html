<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Painel QGI - Lab Sync</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <link rel="icon" type="image/png" href="./icon.png">
  <link rel="apple-touch-icon" href="./icon.png">

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        if (window.location.protocol.startsWith('http')) {
          try {
            navigator.serviceWorker.register('./service-worker.js').catch(e => console.warn("SW Falhou:", e));
          } catch (e) { console.warn("SW não suportado."); }
        }
      });
    }

    window.hardResetApp = async () => {
      try {
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (let registration of registrations) await registration.unregister();
        }
        localStorage.clear();
        if ('caches' in window) {
           const names = await caches.keys();
           for (let name of names) await caches.delete(name);
        }
      } catch(e) { console.log("Reset error", e); }
      window.location.reload(true);
    };

    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          animation: { 'fade-in-down': 'fadeInDown 0.8s ease-out' },
          keyframes: { fadeInDown: { '0%': { opacity: '0', transform: 'translateY(-20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
        }
      }
    }
  </script>
  
  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #0f172a; }
    @media print {
      @page { size: landscape; margin: 0.5cm; }
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background-color: white !important; color: black !important; font-size: 11pt; width: 100%; }
      .print-container { width: 100%; }
      table.print-table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-bottom: 20px; 
        font-size: 9pt; 
        table-layout: fixed;
      }
      table.print-table th, table.print-table td { 
        border: 1px solid #000; 
        padding: 4px; 
        text-align: center; 
        vertical-align: top;
        word-wrap: break-word;
      }
      table.print-table th { background-color: #e0e0e0 !important; font-weight: bold; }
      .page-break { page-break-before: always; break-before: page; display: block; height: 1px; }
      .signature-block { margin-top: 40px; display: flex; justify-content: space-around; }
      .signature-line { border-top: 1px solid black; width: 40%; text-align: center; padding-top: 5px; }
    }
    .print-only { display: none; }
  </style>

  <!-- FIREBASE SETUP -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, collection, onSnapshot, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDrRjL0GW8n8_9edX5sQpRNx1pqyofajMQ",
      authDomain: "labqgi.firebaseapp.com",
      projectId: "labqgi",
      storageBucket: "labqgi.firebasestorage.app",
      messagingSenderId: "325320235954",
      appId: "1:325320235954:web:4fbc77a721ec60238ba2ab",
      measurementId: "G-07WB7J92NQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    window.LAB_ID = "lab_qgi_principal"; 

    signInAnonymously(auth).catch(console.error);
    try { enableIndexedDbPersistence(db).catch(() => {}); } catch(e) {}

    window.db = db; 
    window.doc = doc; 
    window.collection = collection;
    window.onSnapshot = onSnapshot; 
    window.setDoc = setDoc;
    window.auth = auth;

    window.dispatchEvent(new Event('firebase-ready'));
  </script>
</head>
<body class="text-slate-100 overflow-x-hidden selection:bg-blue-500 selection:text-white">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // --- SYNC HOOK ---
    function useSyncedState(key, initialValue) {
      const [data, setData] = useState(() => {
        try {
            const saved = localStorage.getItem(`qgi_${key}`);
            const parsed = saved ? JSON.parse(saved) : initialValue;
            if (Array.isArray(initialValue) && !Array.isArray(parsed)) return initialValue;
            return parsed;
        } catch (e) { return initialValue; }
      });
      const isRemoteUpdate = useRef(false);

      useEffect(() => {
        let unsubscribe = () => {};
        const connect = () => {
          if (!window.db) return;
          unsubscribe = window.onSnapshot(window.doc(window.db, "labs", window.LAB_ID, "data", key), (snap) => {
            if (snap.exists()) {
              const remote = snap.data().content;
              if (Array.isArray(initialValue) && !Array.isArray(remote)) return;
              if (JSON.stringify(remote) !== JSON.stringify(data)) {
                isRemoteUpdate.current = true;
                setData(remote);
                localStorage.setItem(`qgi_${key}`, JSON.stringify(remote));
              }
            } else {
                if (data === undefined || data === null) setData(initialValue);
            }
          });
        };
        if (window.db) connect(); else window.addEventListener('firebase-ready', connect);
        return () => { unsubscribe(); window.removeEventListener('firebase-ready', connect); };
      }, [key]);

      const update = (newDataOrFn) => {
        const newData = typeof newDataOrFn === 'function' ? newDataOrFn(data) : newDataOrFn;
        isRemoteUpdate.current = false;
        setData(newData);
        localStorage.setItem(`qgi_${key}`, JSON.stringify(newData));
        if (window.db) window.setDoc(window.doc(window.db, "labs", window.LAB_ID, "data", key), { content: newData }, { merge: true });
      };
      return [data, update];
    }

    const Icon = ({ path, size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
    const Icons = {
      Beaker: (p) => <Icon {...p} path={<><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></>} />,
      ClipboardList: (p) => <Icon {...p} path={<><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>} />,
      Plus: (p) => <Icon {...p} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
      Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
      ArrowLeft: (p) => <Icon {...p} path={<><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>} />,
      Calendar: (p) => <Icon {...p} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />,
      CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
      Lock: (p) => <Icon {...p} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
      Unlock: (p) => <Icon {...p} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>} />,
      Printer: (p) => <Icon {...p} path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></>} />,
      Trash2: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
      User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
      GraduationCap: (p) => <Icon {...p} path={<><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></>} />,
      FlaskConical: (p) => <Icon {...p} path={<><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></>} />,
      ShieldCheck: (p) => <Icon {...p} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></>} />,
      Users: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
      ShieldAlert: (p) => <Icon {...p} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
      Pencil: (p) => <Icon {...p} path={<><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></>} />,
      Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
      AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
      Archive: (p) => <Icon {...p} path={<><polyline points="21 8 21 21 3 21 3 8"/><rect width="22" height="5" x="1" y="3"/><line x1="10" x2="14" y1="12" y2="12"/></>} />,
      History: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></>} />,
      Filter: (p) => <Icon {...p} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />,
      FolderOpen: (p) => <Icon {...p} path={<><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"/></>} />,
      Bell: (p) => <Icon {...p} path={<><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></>} />,
      Cloud: (p) => <Icon {...p} path={<><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M12 13.5V5"/><path d="m15.5 8.5-3.5-3.5-3.5 3.5"/></>} />,
      Refresh: (p) => <Icon {...p} path={<><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></>} />,
      Megaphone: (p) => <Icon {...p} path={<><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></>} />,
      MessageSquare: (p) => <Icon {...p} path={<><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></>} />,
      ArrowRightLeft: (p) => <Icon {...p} path={<><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></>} />,
      Calculator: (p) => <Icon {...p} path={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />,
      Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />,
      ExternalLink: (p) => <Icon {...p} path={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></>} />,
      ChevronLeft: (p) => <Icon {...p} path={<><polyline points="15 18 9 12 15 6" /></>} />,
      ChevronRight: (p) => <Icon {...p} path={<><polyline points="9 18 15 12 9 6" /></>} />,
      X: (p) => <Icon {...p} path={<><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></>} />,
      Gauge: (p) => <Icon {...p} path={<><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></>} />
    };

    // --- DADOS INICIAIS ---
    const INITIAL_REAGENTS = [
      { id: '1', type: 'reagent', name: 'Ácido Clorídrico', brand: 'Sigma', lot: 'A102', expiryDate: '2023-12-01', usage: 'Titulação' },
      { id: '2', type: 'reagent', name: 'Bicarbonato de Sódio', brand: 'Merck', lot: 'B550', expiryDate: '2026-05-20', usage: 'Soluções' },
      { id: 'p1', type: 'standard', name: 'Fósforo - Verificação', concentration: '1000', unit: 'mg/L', openingDate: '2024-08-13', expiryDate: '2026-01-31', brand: 'ABSOLUTE STANDARDS', lot: '013123', usage: 'Verificação' },
      { id: 'p2', type: 'standard', name: 'Alcalinidade Verificação', concentration: '1000', unit: 'mg/L', openingDate: '2025-06-16', expiryDate: '2026-05-31', brand: 'Specsol', lot: 'F25COO12E', usage: 'Verificação' },
      { id: 'p3', type: 'standard', name: 'Amonia', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2025-09-30', brand: 'QMC', lot: '4488/23', usage: 'Verificação' },
      { id: 'p4', type: 'standard', name: 'Bromato - Verificação', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2025-11-30', brand: 'NSI LAB SOLUTIONS', lot: '211108', usage: 'Verificação' },
      { id: 'p5', type: 'standard', name: 'Cianeto Curva', concentration: '997', unit: 'mg/L', openingDate: '', expiryDate: '2027-08-18', brand: 'CPA CHEM', lot: '1023406', usage: 'Curva' },
      { id: 'p6', type: 'standard', name: 'Cloreto', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2025-09-30', brand: 'QMC', lot: '4518/23', usage: 'Verificação' },
      { id: 'p7', type: 'standard', name: 'Condutividade 1413 µS/cm', concentration: '1413', unit: 'µS/cm', openingDate: '', expiryDate: '2025-10-12', brand: 'Inorganic Ventures', lot: 'T2-COND 724227', usage: 'Calibração' },
      { id: 'p8', type: 'standard', name: 'DQO', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2027-03-17', brand: 'CPA CHEM', lot: '1083145', usage: 'Verificação' },
      { id: 'p9', type: 'standard', name: 'Fenol', concentration: '1000', unit: 'mg/L', openingDate: '2025-06-16', expiryDate: '2026-05-31', brand: 'Specsol', lot: 'F25D0302E', usage: 'Verificação' },
      { id: 'p10', type: 'standard', name: 'Fluoreto', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-11-13', brand: 'Dinâmica', lot: '152671', usage: 'Verificação' },
      { id: 'p11', type: 'standard', name: 'Nitrato Verificação', concentration: '1000', unit: 'mg/L', openingDate: '2025-06-16', expiryDate: '2026-05-31', brand: 'Specsol', lot: 'F25B0492E', usage: 'Verificação' },
      { id: 'p12', type: 'standard', name: 'pH 4,00 (Tampão)', concentration: '4,00', unit: 'pH', openingDate: '', expiryDate: '2025-12-31', brand: 'Visomes', lot: 'L0742', usage: 'Calibração' },
      { id: 'p13', type: 'standard', name: 'pH 7,00 (Tampão)', concentration: '7,00', unit: 'pH', openingDate: '', expiryDate: '2025-09-07', brand: 'CPA CHEM', lot: '926518', usage: 'Calibração' },
      { id: 'p14', type: 'standard', name: 'pH 10,00 (Tampão)', concentration: '10,00', unit: 'pH', openingDate: '', expiryDate: '2026-12-31', brand: 'Merck', lot: 'HC 33255138', usage: 'Calibração' },
      { id: 'p15', type: 'standard', name: 'Turbidez', concentration: '4000', unit: 'NTU', openingDate: '', expiryDate: '2025-03-31', brand: 'Visomes', lot: 'L0750', usage: 'Calibração' },
      { id: 'p16', type: 'standard', name: 'Brometo', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-03-30', brand: 'Absolute Standards', lot: '033023', usage: 'Verificação' },
      { id: 'p17', type: 'standard', name: 'Brometo curva', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-08-31', brand: 'NSI LAB SOLUTIONS', lot: '220815', usage: 'Curva' },
      { id: 'p18', type: 'standard', name: 'Brometo 1000 µg/mL', concentration: '1000', unit: 'µg/mL', openingDate: '', expiryDate: '2025-08-31', brand: 'SCP SCIENCE', lot: 'S231026010', usage: 'Verificação' },
      { id: 'p19', type: 'standard', name: 'Cianeto verificação', concentration: '1004.6', unit: 'mg/L', openingDate: '', expiryDate: '2026-11-11', brand: 'CPA CHEM', lot: '937505', usage: 'Verificação' },
      { id: 'p20', type: 'standard', name: 'CLORATO', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-08-14', brand: 'Absolut Standards', lot: '081423', usage: 'Verificação' },
      { id: 'p21', type: 'standard', name: 'CLORITO-CURVA', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-09-14', brand: 'CPA CHEM', lot: '928707', usage: 'Curva' },
      { id: 'p22', type: 'standard', name: 'Cloro -Verificação', concentration: '1000', unit: 'mg/L', openingDate: '2025-06-16', expiryDate: '2025-11-30', brand: 'Specsol', lot: 'F25C0597E', usage: 'Verificação' },
      { id: 'p23', type: 'standard', name: 'CLORO RESIDUAL LIVRE', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-08-17', brand: 'Absolute Standards', lot: '081723', usage: 'Verificação' },
      { id: 'p24', type: 'standard', name: 'Cromo Hexavalente', concentration: '996', unit: 'mg/L', openingDate: '', expiryDate: '2027-05-15', brand: 'CPA CHEM', lot: '991231', usage: 'Verificação' },
      { id: 'p25', type: 'standard', name: 'Dureza', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2027-03-04', brand: 'CPA CHEM', lot: '1083146', usage: 'Verificação' },
      { id: 'p26', type: 'standard', name: 'Fluoreto', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2025-11-30', brand: 'QMC', lot: '5723/73', usage: 'Verificação' },
      { id: 'p27', type: 'standard', name: 'FOSFATO (verificação)', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-11-22', brand: 'Dinâmica', lot: '152865', usage: 'Verificação' },
      { id: 'p28', type: 'standard', name: 'Glifosato Curva', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-03-09', brand: 'Absolute Standards', lot: '030921', usage: 'Curva' },
      { id: 'p29', type: 'standard', name: 'Nitrato', concentration: '4424.78', unit: 'mg/L', openingDate: '', expiryDate: '2026-02-28', brand: 'QMC', lot: '178/24', usage: 'Verificação' },
      { id: 'p30', type: 'standard', name: 'ÓLEO E GRAXAS CURVA', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2027-10-19', brand: 'Absolute Standards', lot: '101922', usage: 'Curva' },
      { id: 'p31', type: 'standard', name: 'Padrão de Cor 500', concentration: '500', unit: 'mg/L', openingDate: '2023-03-17', expiryDate: '2025-12-15', brand: 'Absolute Standards', lot: '121522', usage: 'Calibração' },
      { id: 'p32', type: 'standard', name: 'Sólidos Totais Dissolvidos', concentration: '1001', unit: 'mg/L', openingDate: '', expiryDate: '2026-08-17', brand: 'CPA CHEM', lot: '1023405', usage: 'Calibração' },
      { id: 'p33', type: 'standard', name: 'Sólidos totais voláteis', concentration: '50', unit: 'mg/L', openingDate: '', expiryDate: '2031-08-19', brand: 'Absolute Standards', lot: '081921', usage: 'Verificação' },
      { id: 'p34', type: 'standard', name: 'SULFATO', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-04-30', brand: 'QMC', lot: '2195/24', usage: 'Verificação' },
      { id: 'p35', type: 'standard', name: 'SULFATO-Verificação', concentration: '1000', unit: 'mg/L', openingDate: '2025-06-16', expiryDate: '2026-05-31', brand: 'Specsol', lot: 'F25D0847E', usage: 'Verificação' },
      { id: 'p36', type: 'standard', name: 'SULFATO-curva', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-01-31', brand: 'NSI LAB SOLUTIONS', lot: '220128', usage: 'Curva' },
      { id: 'p37', type: 'standard', name: 'Surfactantes Curva', concentration: '1000', unit: 'mg/L', openingDate: '', expiryDate: '2026-08-15', brand: 'CPA CHEM', lot: '1023407', usage: 'Curva' },
      { id: 'p38', type: 'standard', name: 'Tampão 10 Calibração', concentration: '10.00', unit: 'pH', openingDate: '', expiryDate: '2026-08-17', brand: 'CPA CHEM', lot: '1023424', usage: 'Calibração' },
      { id: 'p39', type: 'standard', name: 'Tampão 10 Verificação', concentration: '10.00', unit: 'pH', openingDate: '', expiryDate: '2026-08-17', brand: 'CPA CHEM', lot: '1023401', usage: 'Verificação' },
      { id: 'p40', type: 'standard', name: 'Tampão 10,00 Verificação', concentration: '10.00', unit: 'pH', openingDate: '', expiryDate: '2027-07-12', brand: 'Dinâmica', lot: '148399', usage: 'Verificação' },
      { id: 'p41', type: 'standard', name: 'Tampão 4,00', concentration: '4.00', unit: 'pH', openingDate: '', expiryDate: '2028-08-28', brand: 'Dinâmica', lot: '149853', usage: 'Calibração' },
      { id: 'p42', type: 'standard', name: 'Tampão 7,00', concentration: '7.00', unit: 'pH', openingDate: '', expiryDate: '2027-07-04', brand: 'Dinâmica', lot: '148123', usage: 'Calibração' }
    ];

    const INITIAL_STAFF = [
      { id: 's1', name: 'Reinan Souza', role: 'Tecnico', tasks: [{ id: 't1', text: 'Cor real e Aparente' }, { id: 't2', text: 'Cloro Residual' }], qualityTasks: [] },
      { id: 's2', name: 'Glaucia Haack', role: 'Tecnico', tasks: [{ id: 't3', text: 'Cianotoxinas' }], qualityTasks: [] },
      { id: 's3', name: 'Adriana Goes', role: 'Tecnico', tasks: [], qualityTasks: [] },
      { id: 's4', name: 'Franciesco Pinto', role: 'Tecnico', tasks: [{ id: 't4', text: 'Dureza total' }], qualityTasks: [] },
      { id: 's5', name: 'Sandra Helena', role: 'Tecnico', tasks: [{ id: 't5', text: 'Óleos e Graxas' }], qualityTasks: [] },
      { id: 's6', name: 'Antônio Fidelis', role: 'Estagiario', tasks: [{ id: 't6', text: 'Fósforo' }], qualityTasks: [] },
      { id: 's7', name: 'Victor Luiz', role: 'Estagiario', tasks: [{ id: 't7', text: 'DBO e DQO' }], qualityTasks: [] },
    ];

    const INITIAL_ARMY_REAGENTS = [
      { id: 'a1', name: 'Ácido Fluorídrico (Fluoreto de hidrogênio)', quantity: 0, unit: 'mL' },
      { id: 'a2', name: 'Ácido Nítrico em Solução c/ conc. ≥ 55%', quantity: 0, unit: 'mL' },
      { id: 'a3', name: 'Ácido Perclórico', quantity: 0, unit: 'mL' },
      { id: 'a4', name: 'Álcool 2-Cloetilico (2-Cloroetano)', quantity: 0, unit: 'und' },
      { id: 'a5', name: 'Azida de Sódio', quantity: 100, unit: 'g' },
      { id: 'a6', name: 'Cianeto de Potássio', quantity: 0, unit: 'g' },
      { id: 'a7', name: 'Fluoreto de Potássio', quantity: 0, unit: 'g' },
      { id: 'a8', name: 'Fluoreto de Sódio', quantity: 0, unit: 'g' },
      { id: 'a9', name: 'Hidrazina - adquirido em ampolas', quantity: 0, unit: 'und' },
      { id: 'a10', name: 'Nitrato de amônio (Líquido)', quantity: 0, unit: 'mL' },
      { id: 'a11', name: 'Nitrato de amônio (Sólido)', quantity: 0, unit: 'g' },
      { id: 'a12', name: 'Nitrato de Mercúrio', quantity: 0, unit: 'g' },
      { id: 'a13', name: 'Nitrato de Potássio', quantity: 0, unit: 'g' },
      { id: 'a14', name: 'Sulfeto de Sódio', quantity: 0, unit: 'g' },
      { id: 'a15', name: 'Trietanolamina', quantity: 0, unit: 'mL' }
    ];

    function QGIDashboard() {
      const [currentView, setCurrentView] = useState('home');
      const renderView = () => {
        switch (currentView) {
          case 'reagents': return <ReagentManager onBack={() => setCurrentView('home')} />;
          case 'tasks': return <TaskManager onBack={() => setCurrentView('home')} />;
          case 'army': return <ArmyControlledManager onBack={() => setCurrentView('home')} />;
          case 'notices': return <NoticeBoard onBack={() => setCurrentView('home')} />;
          case 'calendar': return <AdministrativeCalendar onBack={() => setCurrentView('home')} />;
          default: return <HomeDashboard onNavigate={setCurrentView} />;
        }
      };
      return <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-100">{renderView()}</div>;
    }

    function HomeDashboard({ onNavigate }) {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [notifications, setNotifications] = useState({ expired: 0, expiring: 0, armyReport: false });
      const [onlineUsers, setOnlineUsers] = useState(1);
      const [permission, setPermission] = useState(Notification.permission);
      const [armyReportsStatus] = useSyncedState('army_reports_status', {});

      useEffect(() => { 
        let mounted = true; 
        const t = setInterval(() => { if(mounted) setCurrentDate(new Date()); }, 1000); 

        const checkAndNotify = () => {
          const savedReagents = localStorage.getItem('qgi_reagents');
          if (!savedReagents) return;
          try {
            const reagentsList = JSON.parse(savedReagents);
            const now = new Date();
            let expired = 0, expiring = 0;
            reagentsList.forEach(r => {
              if (r.type === 'history') return;
              const diffDays = Math.ceil((new Date(r.expiryDate) - now) / (1000 * 60 * 60 * 24));
              if (diffDays < 0) expired++; else if (diffDays <= 30) expiring++;
            });
            
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const currentArmyKey = `${months[now.getMonth()]}_${now.getFullYear()}`;
            const isArmyReportSent = armyReportsStatus[currentArmyKey];
            const armyReportPending = !isArmyReportSent && now.getDate() <= 31; 

            if (mounted) setNotifications({ expired, expiring, armyReport: armyReportPending });
          } catch(e) {}
        };
        checkAndNotify();

        if (window.db && window.LAB_ID && window.auth) {
           const handlePresence = async () => {
             const user = window.auth.currentUser;
             if (!user) return;
             const uid = user.uid;
             const presenceRef = window.doc(window.db, 'labs', window.LAB_ID, 'presence', uid);
             const heartbeat = setInterval(() => {
                if(mounted) window.setDoc(presenceRef, { lastSeen: Date.now() }, { merge: true });
             }, 30000);
             window.setDoc(presenceRef, { lastSeen: Date.now() }, { merge: true });

             const colRef = window.collection(window.db, 'labs', window.LAB_ID, 'presence');
             const unsubPresence = window.onSnapshot(colRef, (snap) => {
               if(!mounted) return;
               const now = Date.now();
               const activeCount = snap.docs.filter(d => (now - d.data().lastSeen) < 60000).length;
               setOnlineUsers(activeCount || 1);
             });
             return () => { clearInterval(heartbeat); unsubPresence(); };
           };
           handlePresence();
        }

        return () => { mounted = false; clearInterval(t); }; 
      }, [armyReportsStatus]);

      const requestNotifyPermission = () => {
        Notification.requestPermission().then(perm => { setPermission(perm); });
      };

      const formattedDate = currentDate.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
      const formattedTime = currentDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

      return (
        <div className="flex flex-col items-center justify-center min-h-screen p-8 relative">
          <div className="absolute top-6 flex justify-center w-full pointer-events-none">
            <div className="bg-slate-800/80 backdrop-blur-md px-6 py-2 rounded-full border border-slate-700/50 shadow-lg text-slate-300 text-sm font-medium flex items-center gap-3">
              <span className="capitalize">{formattedDate}</span><div className="w-px h-4 bg-slate-600"></div><div className="flex items-center gap-1.5 text-blue-400 font-bold font-mono"><Icons.Clock size={14} /> {formattedTime}</div>
            </div>
          </div>
          <header className="mb-12 text-center mt-12 animate-fade-in-down">
            <div className="inline-flex items-center justify-center p-6 mb-6 bg-blue-600/10 rounded-full ring-1 ring-blue-500/30 shadow-[0_0_60px_rgba(37,99,235,0.15)] backdrop-blur-sm"><Icons.FlaskConical size={64} className="text-blue-400" /></div>
            <h1 className="text-5xl md:text-7xl font-thin tracking-tight text-white mb-2">Laboratório <span className="font-bold text-blue-400 drop-shadow-lg">QGI</span></h1>
            <p className="text-slate-400 text-xl font-light">Gestão Integrada &bull; <span className="text-emerald-400 font-mono text-sm border border-emerald-500/30 px-2 py-0.5 rounded bg-emerald-500/10 inline-flex items-center gap-1"><Icons.Cloud size={12}/> Sync V34</span></p>
            {permission !== 'granted' && <button onClick={requestNotifyPermission} className="mt-6 flex items-center justify-center gap-2 mx-auto text-sm bg-slate-800/80 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-full text-slate-300 transition-all hover:scale-105"><Icons.Bell size={14} /> Ativar Notificações</button>}
          </header>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 w-full max-w-6xl px-4">
            <DashboardCard title="Reagentes & Padrões" description="Controle de validade." icon={<Icons.Beaker size={40} />} color="bg-emerald-500" onClick={() => onNavigate('reagents')} badges={[notifications.expired > 0 ? { text: `${notifications.expired} Vencidos`, color: 'bg-red-500 text-white shadow-red-500/50' } : null, notifications.expiring > 0 ? { text: `${notifications.expiring} Vencendo`, color: 'bg-yellow-500 text-black shadow-yellow-500/50' } : null]} />
            <DashboardCard title="Distribuição & Equipe" description="Gestão de ensaios." icon={<Icons.ClipboardList size={40} />} color="bg-indigo-500" onClick={() => onNavigate('tasks')} />
            <DashboardCard title="Controlados (Exército)" description="Relatório mensal." icon={<Icons.ShieldAlert size={40} />} color="bg-red-600" onClick={() => onNavigate('army')} badges={[notifications.armyReport ? { text: 'RELATÓRIO PENDENTE', color: 'bg-red-600 text-white animate-pulse shadow-red-600/50' } : null]} />
            <DashboardCard title="Mural de Avisos" description="Comunicados internos." icon={<Icons.Megaphone size={40} />} color="bg-amber-500" onClick={() => onNavigate('notices')} />
            <DashboardCard title="Calendário 2026" description="Pagamentos, Feriados e Folgas." icon={<Icons.Calendar size={40} />} color="bg-teal-500" onClick={() => onNavigate('calendar')} />
            
            <button onClick={() => window.open('https://reinansantos138-lab.github.io/labflow-2026/', '_blank')} className="group relative flex flex-col items-start justify-between p-8 h-64 w-full rounded-3xl border border-slate-700/50 bg-slate-800/40 backdrop-blur-xl shadow-2xl transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl hover:border-slate-500 hover:bg-slate-800/60 focus:outline-none text-left overflow-hidden">
               <div className="absolute top-0 right-0 w-32 h-32 bg-purple-600 opacity-20 blur-[60px] rounded-full group-hover:opacity-30 transition-opacity duration-500"></div>
               <div className="w-full flex justify-between items-start">
                  <div className="p-4 rounded-2xl bg-slate-700/30 text-white mb-4 group-hover:scale-110 transition-transform duration-500 shadow-inner ring-1 ring-white/10"><Icons.ExternalLink size={40} /></div>
               </div>
               <div className="relative z-10 w-full mt-auto">
                  <h3 className="text-2xl font-bold text-white mb-2 tracking-wide group-hover:text-blue-300 transition-colors drop-shadow-md">Solicitações & Admin</h3>
                  <p className="text-slate-400 font-medium leading-relaxed group-hover:text-slate-300 transition-colors">Acesso ao painel externo.</p>
               </div>
            </button>
            
            <button onClick={() => window.open('https://reinansantos138-lab.github.io/sistema-calibracao/', '_blank')} className="group relative flex flex-col items-start justify-between p-8 h-64 w-full rounded-3xl border border-slate-700/50 bg-slate-800/40 backdrop-blur-xl shadow-2xl transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl hover:border-slate-500 hover:bg-slate-800/60 focus:outline-none text-left overflow-hidden">
               <div className="absolute top-0 right-0 w-32 h-32 bg-cyan-600 opacity-20 blur-[60px] rounded-full group-hover:opacity-30 transition-opacity duration-500"></div>
               <div className="w-full flex justify-between items-start">
                  <div className="p-4 rounded-2xl bg-slate-700/30 text-white mb-4 group-hover:scale-110 transition-transform duration-500 shadow-inner ring-1 ring-white/10"><Icons.Gauge size={40} /></div>
               </div>
               <div className="relative z-10 w-full mt-auto">
                  <h3 className="text-2xl font-bold text-white mb-2 tracking-wide group-hover:text-cyan-300 transition-colors drop-shadow-md">Sistema de Calibração</h3>
                  <p className="text-slate-400 font-medium leading-relaxed group-hover:text-slate-300 transition-colors">Gestão e certificados.</p>
               </div>
            </button>

            <div className="group relative flex flex-col items-center justify-center p-8 h-64 rounded-3xl border-2 border-dashed border-slate-700/50 bg-slate-800/20 backdrop-blur-sm transition-all duration-300 opacity-60 hover:opacity-100 hover:border-slate-500 hover:bg-slate-800/40 cursor-pointer">
              <div className="bg-slate-700/50 p-4 rounded-full mb-4 transition-transform group-hover:scale-110"><Icons.Plus size={32} className="text-slate-400" /></div>
              <h3 className="text-xl font-medium text-slate-400">Novo Módulo</h3>
              <p className="text-sm text-slate-500 mt-2 text-center">Espaço reservado para<br/>expansão futura.</p>
            </div>
          </div>
          <footer className="mt-12 text-slate-600 text-sm font-medium flex flex-col items-center gap-4">
            <div className="flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-xs font-mono">
               <span className="relative flex h-2 w-2">
                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span className="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
               </span>
               {onlineUsers} {onlineUsers === 1 ? 'Pessoa online' : 'Pessoas online'}
            </div>
            <button onClick={() => window.hardResetApp()} className="flex items-center gap-2 bg-slate-800 border border-slate-700 hover:bg-red-900/30 hover:border-red-800 text-slate-400 hover:text-red-300 px-4 py-2 rounded-full text-xs transition-all">
              <Icons.Refresh size={12} /> Atualizar App (Limpar Cache)
            </button>
          </footer>
        </div>
      );
    }

    function DashboardCard({ title, description, icon, color, onClick, badges }) {
      return (
        <button onClick={onClick} className="group relative flex flex-col items-start justify-between p-8 h-64 w-full rounded-3xl border border-slate-700/50 bg-slate-800/40 backdrop-blur-xl shadow-2xl transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl hover:border-slate-500 hover:bg-slate-800/60 focus:outline-none text-left overflow-hidden">
          <div className={`absolute top-0 right-0 w-32 h-32 ${color} opacity-20 blur-[60px] rounded-full group-hover:opacity-30 transition-opacity duration-500`}></div>
          <div className="w-full flex justify-between items-start">
            <div className={`p-4 rounded-2xl bg-slate-700/30 text-white mb-4 group-hover:scale-110 transition-transform duration-500 shadow-inner ring-1 ring-white/10`}>{icon}</div>
            {badges && badges.some(b => b) && <div className="flex flex-col items-end gap-2 animate-in fade-in slide-in-from-right-4 duration-500">{badges.filter(b => b).map((badge, idx) => <span key={idx} className={`px-3 py-1 rounded-full text-[10px] uppercase tracking-wider font-bold shadow-lg ${badge.color}`}>{badge.text}</span>)}</div>}
          </div>
          <div className="relative z-10 w-full mt-auto">
            <h3 className="text-2xl font-bold text-white mb-2 tracking-wide group-hover:text-blue-300 transition-colors drop-shadow-md">{title}</h3>
            <p className="text-slate-400 font-medium leading-relaxed group-hover:text-slate-300 transition-colors">{description}</p>
          </div>
        </button>
      );
    }

    // --- NOTICE BOARD ---
    function NoticeBoard({ onBack }) {
      const [notices, setNotices] = useSyncedState('notices', []);
      const [author, setAuthor] = useState('');
      const [message, setMessage] = useState('');

      const addNotice = (e) => {
        e.preventDefault();
        if (!author.trim() || !message.trim()) return;

        const newNotice = {
          id: Date.now().toString(),
          author: author,
          message: message,
          date: new Date().toISOString()
        };

        setNotices([newNotice, ...notices]);
        setAuthor('');
        setMessage('');

        if (Notification.permission === 'granted') {
          new Notification(`Novo Aviso de ${newNotice.author}`, {
            body: newNotice.message,
            icon: './icon.png'
          });
        }
      };

      const deleteNotice = (id) => {
        if(confirm('Apagar este aviso?')) {
          setNotices(notices.filter(n => n.id !== id));
        }
      };

      return (
        <div className="min-h-screen bg-slate-900 text-slate-200 p-6 md:p-12">
          <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-800 transition-colors">
                <Icons.ArrowLeft size={24} />
              </button>
              <div>
                <h2 className="text-3xl font-bold text-white flex items-center gap-3">
                  <Icons.Megaphone className="text-amber-500" /> Mural de Avisos
                </h2>
                <p className="text-slate-400 text-sm">Comunicados importantes para a equipe.</p>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-1">
              <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl sticky top-6">
                <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                  <Icons.Plus size={20} /> Novo Aviso
                </h3>
                <form onSubmit={addNotice} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-400 mb-1">Seu Nome</label>
                    <input 
                      className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none"
                      value={author}
                      onChange={e => setAuthor(e.target.value)}
                      placeholder="Ex: João Silva"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-400 mb-1">Mensagem</label>
                    <textarea 
                      className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none h-32 resize-none"
                      value={message}
                      onChange={e => setMessage(e.target.value)}
                      placeholder="Digite o aviso aqui..."
                      required
                    ></textarea>
                  </div>
                  <button type="submit" className="w-full py-3 bg-amber-600 hover:bg-amber-500 text-white font-bold rounded-lg transition-colors">
                    Publicar Aviso
                  </button>
                </form>
              </div>
            </div>

            <div className="lg:col-span-2 space-y-4">
              {notices.length === 0 ? (
                <div className="text-center py-12 text-slate-500 bg-slate-800/30 rounded-2xl border border-slate-700 border-dashed">
                  <Icons.MessageSquare size={48} className="mx-auto mb-4 opacity-50" />
                  <p>Nenhum aviso publicado ainda.</p>
                </div>
              ) : (
                notices.map(notice => (
                  <div key={notice.id} className="bg-slate-800/60 border border-slate-700 p-6 rounded-2xl relative group animate-in fade-in slide-in-from-bottom-4 duration-300">
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex items-center gap-2">
                        <div className="w-8 h-8 rounded-full bg-amber-500/20 text-amber-500 flex items-center justify-center font-bold text-xs">
                          {notice.author.charAt(0).toUpperCase()}
                        </div>
                        <div>
                          <h4 className="font-bold text-white">{notice.author}</h4>
                          <span className="text-xs text-slate-500">
                            {new Date(notice.date).toLocaleDateString('pt-BR')} às {new Date(notice.date).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                          </span>
                        </div>
                      </div>
                      <button 
                        onClick={() => deleteNotice(notice.id)}
                        className="text-slate-600 hover:text-red-400 p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"
                        title="Apagar Aviso"
                      >
                        <Icons.Trash2 size={18} />
                      </button>
                    </div>
                    <p className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap pl-10">
                      {notice.message}
                    </p>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      );
    }

    function TaskManager({ onBack }) {
      const [staff, setStaff] = useSyncedState('staff', INITIAL_STAFF); 
      const [activeTab, setActiveTab] = useState('ensaios'); 
      const [isLocked, setIsLocked] = useState(true);
      const [newTaskText, setNewTaskText] = useState(''); 
      const [selectedStaffId, setSelectedStaffId] = useState(null);
      const [filterRole, setFilterRole] = useState('Todos');
      const [newStaffName, setNewStaffName] = useState('');
      const [newStaffRole, setNewStaffRole] = useState('Tecnico');

      // NOVOS ESTADOS PARA TRANSFERÊNCIA
      const [showTransferModal, setShowTransferModal] = useState(false);
      const [transferData, setTransferData] = useState(null); 
      const [targetStaffId, setTargetStaffId] = useState('');

      // ORDENAÇÃO: Técnicos primeiro, depois alfabética
      const sortedStaff = useMemo(() => {
          return [...staff].sort((a, b) => {
              if (a.role === b.role) return a.name.localeCompare(b.name);
              return a.role === 'Tecnico' ? -1 : 1;
          });
      }, [staff]);

      const filteredStaff = sortedStaff.filter(s => filterRole === 'Todos' || s.role === filterRole);

      const addTask = (staffId, type) => { if (!newTaskText.trim()) return; setStaff(prev => prev.map(s => { if (s.id === staffId) { const task = { id: Date.now().toString(), text: newTaskText }; if (type === 'quality') return { ...s, qualityTasks: [...s.qualityTasks, task] }; return { ...s, tasks: [...s.tasks, task] }; } return s; })); setNewTaskText(''); setSelectedStaffId(null); };
      const removeTask = (staffId, taskId, type) => { if (isLocked) return; setStaff(prev => prev.map(s => { if (s.id === staffId) { if (type === 'quality') return { ...s, qualityTasks: s.qualityTasks.filter(t => t.id !== taskId) }; return { ...s, tasks: s.tasks.filter(t => t.id !== taskId) }; } return s; })); };
      const addStaffMember = (e) => { e.preventDefault(); if (!newStaffName.trim()) return; const newMember = { id: 's_' + Date.now(), name: newStaffName, role: newStaffRole, tasks: [], qualityTasks: [] }; setStaff([...staff, newMember]); setNewStaffName(''); };
      const removeStaffMember = (id) => { if (confirm('Remover este membro e suas tarefas?')) setStaff(staff.filter(s => s.id !== id)); };

      const initiateTransfer = (type, fromId, taskId = null, taskType = null) => {
        setTransferData({ type, fromId, taskId, taskType });
        setShowTransferModal(true);
        setTargetStaffId('');
      };

      const executeTransfer = () => {
        if (!targetStaffId || !transferData) return;
        const { type, fromId, taskId, taskType } = transferData;

        if (type === 'all') {
          // SWAP TOTAL: A -> B e B -> A
          const sourceMember = staff.find(s => s.id === fromId);
          const targetMember = staff.find(s => s.id === targetStaffId);
          if (!sourceMember || !targetMember) return;

          setStaff(prev => prev.map(s => {
            if (s.id === fromId) return { ...s, tasks: targetMember.tasks, qualityTasks: targetMember.qualityTasks };
            if (s.id === targetStaffId) return { ...s, tasks: sourceMember.tasks, qualityTasks: sourceMember.qualityTasks };
            return s;
          }));
        } else if (type === 'single') {
          // Transferência simples de UMA tarefa
          const sourceMember = staff.find(s => s.id === fromId);
          let taskToMove;
          if (taskType === 'quality') taskToMove = sourceMember.qualityTasks.find(t => t.id === taskId);
          else taskToMove = sourceMember.tasks.find(t => t.id === taskId);

          if (!taskToMove) return;

          setStaff(prev => prev.map(s => {
            if (s.id === targetStaffId) {
              if (taskType === 'quality') return { ...s, qualityTasks: [...s.qualityTasks, taskToMove] };
              return { ...s, tasks: [...s.tasks, taskToMove] };
            }
            if (s.id === fromId) {
              if (taskType === 'quality') return { ...s, qualityTasks: s.qualityTasks.filter(t => t.id !== taskId) };
              return { ...s, tasks: s.tasks.filter(t => t.id !== taskId) };
            }
            return s;
          }));
        }
        setShowTransferModal(false);
        setTransferData(null);
      };

      const PrintTable = ({ title, type }) => {
        const maxRows = sortedStaff.reduce((max, member) => Math.max(max, (type === 'quality' ? member.qualityTasks : member.tasks).length), 0);
        const rows = Math.max(maxRows, 5);
        return (
          <div className="print-only print-container">
            <h2 className="text-xl font-bold text-black mb-2 uppercase border-b-2 border-black pb-1">{title}</h2>
            <table className="print-table team-table">
              <thead><tr>{sortedStaff.map(m => <th key={m.id}>{m.name}<br/><span className="font-normal text-[8px] normal-case">{m.role === 'Tecnico' ? 'Técnico(a)' : 'Estagiário(a)'}</span></th>)}</tr></thead>
              <tbody>{Array.from({ length: rows }).map((_, rowIndex) => <tr key={rowIndex}>{sortedStaff.map(m => <td key={m.id}>{(type === 'quality' ? m.qualityTasks : m.tasks)[rowIndex]?.text || ''}</td>)}</tr>)}</tbody>
            </table>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-slate-900 text-slate-200 p-6 md:p-12 print:bg-white print:text-black print:p-0">
          
          <div className="print-only print-container">
            <div className="mb-4 text-center"><h1 className="text-2xl font-bold uppercase">Painel QGI - Relatório</h1></div>
            {/* PÁGINA 1: ENSAIOS */}
            <PrintTable title="Ensaios Analíticos" type="normal" />
            
            {/* QUEBRA DE PÁGINA */}
            <div className="page-break"></div>
            
            {/* PÁGINA 2: QUALIDADE */}
            <PrintTable title="Gestão da Qualidade" type="quality" />
            <div className="signature-block"><div className="signature-line">Responsável</div></div>
          </div>

          <div className="no-print">
            <div className="flex flex-col xl:flex-row xl:items-center justify-between mb-8 gap-6">
              <div className="flex items-center gap-4"><button onClick={onBack} className="p-2 rounded-full hover:bg-slate-800 transition-colors"><Icons.ArrowLeft size={24} /></button><div><h2 className="text-3xl font-bold text-white flex items-center gap-3"><Icons.ClipboardList className="text-indigo-400" /> Distribuição & Equipe</h2><p className="text-slate-400 text-sm">Sincronizado via Nuvem</p></div></div>
              <div className="flex bg-slate-800/50 p-1 rounded-xl border border-slate-700">
                <button onClick={() => setActiveTab('ensaios')} className={`px-4 py-2 rounded-lg text-sm font-medium ${activeTab === 'ensaios' ? 'bg-indigo-600 text-white' : 'text-slate-400'}`}>Ensaios</button>
                <button onClick={() => setActiveTab('qualidade')} className={`px-4 py-2 rounded-lg text-sm font-medium ${activeTab === 'qualidade' ? 'bg-teal-600 text-white' : 'text-slate-400'}`}>Qualidade</button>
                <button onClick={() => setActiveTab('equipe')} className={`px-4 py-2 rounded-lg text-sm font-medium ${activeTab === 'equipe' ? 'bg-slate-700 text-white' : 'text-slate-400'}`}>Equipe</button>
              </div>
            </div>
            {activeTab !== 'equipe' && <div className="flex flex-wrap items-center justify-between gap-4 mb-6 bg-slate-800/30 p-3 rounded-xl border border-slate-700/50"><div className="flex gap-2">{['Todos', 'Tecnico', 'Estagiario'].map((role) => <button key={role} onClick={() => setFilterRole(role)} className={`px-3 py-1.5 rounded text-xs font-bold uppercase ${filterRole === role ? 'bg-slate-700 text-white' : 'text-slate-500'}`}>{role === 'Tecnico' ? 'Técnicos' : role === 'Estagiario' ? 'Estagiários' : 'Todos'}</button>)}</div><div className="flex items-center gap-3"><button onClick={() => setIsLocked(!isLocked)} className={`flex items-center gap-2 px-3 py-1.5 rounded text-sm font-medium border ${isLocked ? 'bg-slate-800 border-slate-600 text-slate-400' : 'bg-red-500/10 border-red-500/50 text-red-400 animate-pulse'}`}>{isLocked ? <Icons.Lock size={14} /> : <Icons.Unlock size={14} />} {isLocked ? 'Travado' : 'Editando'}</button><button onClick={()=>window.print()} className="p-2 rounded bg-slate-100 text-slate-900"><Icons.Printer size={18} /></button></div></div>}
            
            {activeTab === 'equipe' ? (
              <div className="max-w-4xl mx-auto"><div className="bg-slate-800 rounded-2xl p-6 border border-slate-700 mb-8"><form onSubmit={addStaffMember} className="flex flex-col md:flex-row gap-4"><input type="text" placeholder="Nome completo..." value={newStaffName} onChange={(e) => setNewStaffName(e.target.value)} className="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white" /><select value={newStaffRole} onChange={(e) => setNewStaffRole(e.target.value)} className="bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white"><option value="Tecnico">Técnico</option><option value="Estagiario">Estagiário</option></select><button type="submit" className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-6 py-3 rounded-lg">Adicionar</button></form></div><div className="space-y-3">{sortedStaff.map(member => <div key={member.id} className="flex items-center justify-between p-4 bg-slate-800/50 border border-slate-700 rounded-xl"><div className="flex items-center gap-4"><div className={`p-3 rounded-full ${member.role === 'Tecnico' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-purple-500/20 text-purple-400'}`}>{member.role === 'Tecnico' ? <Icons.User size={20} /> : <Icons.GraduationCap size={20} />}</div><div><h4 className="font-bold text-white text-lg">{member.name}</h4><span className="text-sm text-slate-400">{member.role === 'Tecnico' ? 'Técnico(a)' : 'Estagiário(a)'}</span></div></div><button onClick={() => removeStaffMember(member.id)} className="p-2 text-slate-500 hover:text-red-400"><Icons.Trash2 size={20} /></button></div>)}</div></div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">{filteredStaff.map((person) => { 
                const currentTasks = activeTab === 'qualidade' ? person.qualityTasks : person.tasks; 
                const taskType = activeTab === 'qualidade' ? 'quality' : 'normal'; 
                // CORREÇÃO: Cores mais distintas para Técnicos vs Estagiários
                const roleColor = person.role === 'Tecnico' 
                    ? 'border-l-4 border-l-blue-500 shadow-blue-500/10' 
                    : 'border-l-4 border-l-fuchsia-500 shadow-fuchsia-500/10';

                return (
                  <div key={person.id} className={`flex flex-col bg-slate-800 border border-slate-700 rounded-xl overflow-hidden shadow-lg ${roleColor}`}>
                    <div className="p-4 bg-slate-900/50 border-b border-slate-700 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                         <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${person.role === 'Tecnico' ? 'bg-blue-500/20 text-blue-400' : 'bg-fuchsia-500/20 text-fuchsia-400'}`}>{person.name.charAt(0)}</div>
                         <div><h3 className="font-bold text-white text-sm">{person.name}</h3><span className="text-[10px] text-slate-400 uppercase tracking-widest">{person.role}</span></div>
                      </div>
                      {!isLocked && <button onClick={() => initiateTransfer('all', person.id)} className="p-1.5 rounded-lg text-slate-400 hover:bg-slate-700 hover:text-blue-400 transition-colors" title="Trocar Todas as Tarefas"><Icons.ArrowRightLeft size={16} /></button>}
                    </div>

                    <div className="flex-1 p-3 bg-slate-800/50 min-h-[200px] space-y-2">
                      {currentTasks.length === 0 ? <div className="h-full flex flex-col items-center justify-center text-slate-600"><span className="text-xs italic">Sem tarefas</span></div> : 
                        currentTasks.map((task) => (
                          <div key={task.id} className="group relative flex items-center justify-between p-3 rounded-lg bg-slate-700/40 border border-slate-600/30 hover:border-slate-500 hover:bg-slate-700/60 transition-all">
                              <span className="text-sm text-slate-200 font-medium leading-tight pr-8">{task.text}</span>
                              {!isLocked && (
                                <div className="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-800/90 p-1 rounded-md shadow-lg backdrop-blur-sm">
                                  <button onClick={() => initiateTransfer('single', person.id, task.id, taskType)} className="p-1.5 text-slate-400 hover:text-blue-400 hover:bg-slate-700 rounded"><Icons.ArrowRightLeft size={14} /></button>
                                  <button onClick={() => removeTask(person.id, task.id, taskType)} className="p-1.5 text-slate-400 hover:text-red-400 hover:bg-slate-700 rounded"><Icons.Trash2 size={14} /></button>
                                </div>
                              )}
                          </div>
                        ))
                      }
                    </div>

                    {!isLocked && <div className="p-3 bg-slate-900/80 border-t border-slate-700">{selectedStaffId === person.id ? <div className="flex gap-2 animate-in slide-in-from-bottom-2 fade-in duration-200"><input autoFocus type="text" className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500" placeholder="Nova tarefa..." value={newTaskText} onChange={(e) => setNewTaskText(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addTask(person.id, taskType)} /><button onClick={() => addTask(person.id, taskType)} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-500"><Icons.Plus size={18} /></button></div> : <button onClick={() => setSelectedStaffId(person.id)} className="w-full py-2 flex items-center justify-center gap-2 text-xs font-bold text-slate-400 hover:text-blue-400 hover:bg-slate-800 rounded-lg border border-dashed border-slate-700 hover:border-blue-500/50 transition-all uppercase tracking-wider"><Icons.Plus size={12} /> Adicionar</button>}</div>}
                  </div>
                );
              })}</div>
            )}
          </div>
          
          {/* MODAL TRANSFERÊNCIA (SWAP) */}
          {showTransferModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 no-print">
              <div className="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-in zoom-in duration-200">
                <div className="text-center mb-6">
                  <div className="w-12 h-12 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center mx-auto mb-3">
                    <Icons.ArrowRightLeft size={24} />
                  </div>
                  <h3 className="text-lg font-bold text-white">
                    {transferData.type === 'all' ? 'Trocar Todas as Tarefas' : 'Transferir Tarefa'}
                  </h3>
                  <p className="text-sm text-slate-400 mt-1">
                    {transferData.type === 'all' ? 'Selecione o parceiro para realizar a troca completa de ensaios.' : 'Selecione quem irá receber esta tarefa.'}
                  </p>
                </div>
                <select 
                  className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white mb-6 focus:outline-none focus:border-blue-500 appearance-none cursor-pointer hover:bg-slate-950 transition-colors"
                  value={targetStaffId}
                  onChange={(e) => setTargetStaffId(e.target.value)}
                >
                  <option value="">Selecione um técnico...</option>
                  {sortedStaff.filter(s => s.id !== transferData.fromId).map(s => (
                    <option key={s.id} value={s.id}>{s.name} ({s.role})</option>
                  ))}
                </select>
                <div className="flex gap-3">
                  <button onClick={() => setShowTransferModal(false)} className="flex-1 py-3 rounded-lg text-slate-400 hover:bg-slate-700 font-medium transition-colors">Cancelar</button>
                  <button onClick={executeTransfer} className="flex-1 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled={!targetStaffId}>Confirmar</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // --- ADMINISTRATIVE CALENDAR (ATUALIZADO) ---
    function AdministrativeCalendar({ onBack }) {
      const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
      const [events, setEvents] = useSyncedState('calendar_events', {});
      const [selectedDate, setSelectedDate] = useState(null);
      
      const [showNoteModal, setShowNoteModal] = useState(false);
      const [noteText, setNoteText] = useState('');
      const [noteDate, setNoteDate] = useState('');
      const [noteAuthor, setNoteAuthor] = useState('');
      
      const [staff] = useSyncedState('staff', INITIAL_STAFF);

      // CORES E TIPOS
      const EVENT_TYPES = {
        PAYMENT: { color: 'bg-blue-600 text-white', label: 'Pagamento' },
        HOLIDAY: { color: 'bg-orange-500 text-white', label: 'Feriado' },
        COMP_OFF: { color: 'bg-purple-500 text-white', label: 'Folga Compensada' },
        DAY_OFF: { color: 'bg-red-600 text-white', label: 'Folga' },
        THIRTEENTH: { color: 'bg-green-600 text-white', label: '13º Salário' },
        NONE: { color: 'bg-slate-800 text-slate-300', label: '' }
      };

      useEffect(() => {
        if (events['2026-01-16']) {
             const newEv = {...events};
             delete newEv['2026-01-16'];
             delete newEv['2026-01-30']; 
             setEvents(newEv);
        }
      }, []);

      const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
      const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
      const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
      const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));

      const handleDayClick = (dateStr) => {
        if (selectedDate === dateStr) {
            setSelectedDate(null);
        } else {
            setSelectedDate(dateStr);
        }
      };

      const handleSetType = (type) => {
        if (!selectedDate) return;
        const currentEvent = events[selectedDate] || { type: 'NONE', note: '' };
        
        const newEvents = { ...events };
        if (type === 'NONE') {
             if (currentEvent.note) {
                 newEvents[selectedDate] = { ...currentEvent, type: 'NONE' };
             } else {
                 delete newEvents[selectedDate];
             }
        } else {
            newEvents[selectedDate] = { ...currentEvent, type };
        }
        setEvents(newEvents);
      };

      const handleDayDoubleClick = (dateStr) => {
        const currentEvent = events[dateStr] || { type: 'NONE', note: '', author: '' };
        setNoteDate(dateStr);
        setNoteText(currentEvent.note || '');
        setNoteAuthor(currentEvent.author || '');
        setShowNoteModal(true);
      };

      const saveNote = () => {
         if (!noteDate) return;
         const currentEvent = events[noteDate] || { type: 'NONE', note: '' };
         const newEvents = { ...events };
         
         if (!noteText && currentEvent.type === 'NONE') {
             delete newEvents[noteDate];
         } else {
             newEvents[noteDate] = { ...currentEvent, note: noteText, author: noteAuthor };
         }
         setEvents(newEvents);
         setShowNoteModal(false);
      };

      const todayStr = new Date().toISOString().split('T')[0];

      const renderCalendar = () => {
        const daysInMonth = getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth());
        const firstDay = getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth());
        const days = [];
        
        for (let i = 0; i < firstDay; i++) {
          days.push(<div key={`empty-${i}`} className="h-24 md:h-32 bg-slate-900/50 border border-slate-700/50"></div>);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const event = events[dateStr] || { type: 'NONE', note: '' };
          const style = EVENT_TYPES[event.type] || EVENT_TYPES.NONE;
          const isWeekend = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).getDay() === 0 || new Date(currentDate.getFullYear(), currentDate.getMonth(), day).getDay() === 6;
          const isSelected = selectedDate === dateStr;
          const isToday = dateStr === todayStr;

          days.push(
            <div 
                key={day} 
                className={`h-24 md:h-32 border p-1 relative flex flex-col justify-between cursor-pointer transition-all select-none overflow-hidden
                    ${style.color} 
                    ${isSelected ? 'ring-2 ring-white border-transparent z-10 scale-[1.02] shadow-xl' : 'border-slate-700'}
                    ${isToday ? 'ring-2 ring-emerald-400' : ''}
                    ${event.type === 'NONE' && isWeekend ? 'bg-slate-800/40' : ''} 
                    ${event.type === 'NONE' && !isWeekend ? 'bg-slate-800 hover:bg-slate-700' : ''}`}
                onClick={() => handleDayClick(dateStr)}
                onDoubleClick={(e) => { e.stopPropagation(); handleDayDoubleClick(dateStr); }}
            >
              <div className="flex justify-between items-start">
                  <span className={`text-sm font-bold ml-1 mt-1 ${isToday ? 'text-emerald-400' : ''}`}>{day}</span>
                  {isToday && <span className="text-[9px] text-emerald-400 font-bold uppercase mr-1 mt-1">Hoje</span>}
              </div>
              
              <div className="flex flex-col items-start px-1 w-full">
                 {/* NOTA EXPANDIDA NO BLOCO */}
                 {event.note && (
                    <div className="bg-white/20 backdrop-blur-sm rounded p-1 mb-1 w-full text-[9px] leading-tight text-white truncate" title={`${event.author ? event.author + ': ' : ''}${event.note}`}>
                       {event.author && <span className="font-bold block">{event.author.split(' ')[0]}</span>}
                       {event.note.substring(0, 25)}{event.note.length > 25 ? '...' : ''}
                    </div>
                 )}
                 {event.type !== 'NONE' && <span className="text-[9px] uppercase font-bold tracking-wider opacity-90 self-end mr-1 mb-1">{style.label}</span>}
              </div>
            </div>
          );
        }
        return days;
      };

      const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

      return (
        <div className="min-h-screen bg-slate-900 text-slate-200 p-6 md:p-12 pb-32">
          <div className="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-800 transition-colors"><Icons.ArrowLeft size={24} /></button>
              <div>
                <h2 className="text-3xl font-bold text-white flex items-center gap-3"><Icons.Calendar className="text-teal-400" /> Calendário 2026</h2>
                <p className="text-slate-400 text-sm">Pagamentos, Feriados e Folgas.</p>
              </div>
            </div>
            <div className="flex items-center gap-4 bg-slate-800 p-2 rounded-xl border border-slate-700">
               <button onClick={prevMonth} className="p-2 hover:bg-slate-700 rounded-lg"><Icons.ChevronLeft size={20}/></button>
               <h3 className="text-xl font-bold w-40 text-center">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</h3>
               <button onClick={nextMonth} className="p-2 hover:bg-slate-700 rounded-lg"><Icons.ChevronRight size={20}/></button>
            </div>
          </div>

          <div className="bg-slate-800 border border-slate-700 rounded-2xl shadow-xl overflow-hidden mb-6">
            <div className="grid grid-cols-7 bg-slate-900 border-b border-slate-700 text-center py-3 text-sm font-bold text-slate-400 uppercase">
              <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
            </div>
            <div className="grid grid-cols-7">
              {renderCalendar()}
            </div>
          </div>
          
          <p className="text-center text-slate-500 text-xs mt-6 mb-24">* Clique para selecionar. Duplo clique para adicionar nota/falta.</p>

          {/* BARRA DE AÇÕES */}
          {selectedDate && (
             <div className="fixed bottom-0 left-0 w-full bg-slate-900/95 backdrop-blur-md border-t border-slate-700 p-4 animate-in slide-in-from-bottom-10 shadow-2xl z-40">
                <div className="max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                   <div className="text-white font-bold text-sm md:text-base whitespace-nowrap">
                      {selectedDate.split('-').reverse().join('/')}
                   </div>
                   <div className="flex flex-wrap gap-2 justify-center w-full">
                      <button onClick={() => handleSetType('PAYMENT')} className="flex-1 min-w-[80px] py-3 bg-blue-600 hover:bg-blue-500 rounded text-[10px] md:text-xs font-bold text-white uppercase">Pagamento</button>
                      <button onClick={() => handleSetType('HOLIDAY')} className="flex-1 min-w-[80px] py-3 bg-orange-500 hover:bg-orange-400 rounded text-[10px] md:text-xs font-bold text-white uppercase">Feriado</button>
                      <button onClick={() => handleSetType('COMP_OFF')} className="flex-1 min-w-[80px] py-3 bg-purple-500 hover:bg-purple-400 rounded text-[10px] md:text-xs font-bold text-white uppercase">Folga Comp.</button>
                      <button onClick={() => handleSetType('DAY_OFF')} className="flex-1 min-w-[80px] py-3 bg-red-600 hover:bg-red-500 rounded text-[10px] md:text-xs font-bold text-white uppercase">Folga</button>
                      <button onClick={() => handleSetType('THIRTEENTH')} className="flex-1 min-w-[80px] py-3 bg-green-600 hover:bg-green-500 rounded text-[10px] md:text-xs font-bold text-white uppercase">13º Sal.</button>
                      <button onClick={() => handleSetType('NONE')} className="flex-1 min-w-[80px] py-3 bg-slate-700 hover:bg-slate-600 rounded text-[10px] md:text-xs font-bold text-slate-300 uppercase">Limpar</button>
                   </div>
                </div>
             </div>
          )}

          {/* MODAL DE NOTA */}
          {showNoteModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
               <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl shadow-2xl p-6 animate-in zoom-in duration-200">
                  <div className="flex justify-between items-start mb-4">
                      <h3 className="text-xl font-bold text-white">Adicionar Observação</h3>
                      <button onClick={() => setShowNoteModal(false)} className="text-slate-500 hover:text-white"><Icons.X size={20}/></button>
                  </div>
                  <p className="text-sm text-slate-400 mb-4">Dia: <span className="text-white font-mono">{noteDate.split('-').reverse().join('/')}</span></p>
                  
                  <div className="space-y-4">
                      <div>
                          <label className="text-xs text-slate-500 uppercase mb-1 block">Membro da Equipe</label>
                          <select 
                            className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none"
                            value={noteAuthor}
                            onChange={(e) => setNoteAuthor(e.target.value)}
                          >
                            <option value="">Selecione...</option>
                            {staff.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                          </select>
                      </div>

                      <div>
                          <label className="text-xs text-slate-500 uppercase mb-1 block flex justify-between">
                             <span>Motivo / Lembrete</span>
                             <span className={noteText.length > 25 ? 'text-red-500' : ''}>{noteText.length}/25</span>
                          </label>
                          <input 
                            className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none"
                            placeholder="Ex: Falta médica, Troca..."
                            value={noteText}
                            onChange={(e) => setNoteText(e.target.value.slice(0, 25))} 
                            autoFocus
                          />
                          <p className="text-[10px] text-slate-500 mt-1">Máximo de 25 caracteres para caber no calendário.</p>
                      </div>
                  </div>

                  <div className="flex gap-3 mt-6">
                    <button onClick={() => setShowNoteModal(false)} className="flex-1 py-3 rounded-lg text-slate-400 hover:bg-slate-700 transition-colors">Cancelar</button>
                    <button onClick={saveNote} className="flex-1 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold transition-colors shadow-lg shadow-blue-900/20">Salvar Nota</button>
                  </div>
               </div>
            </div>
          )}

        </div>
      );
    }

    function ReagentManager({ onBack }) {
      const [reagents, setReagents] = useSyncedState('reagents', INITIAL_REAGENTS); 
      const [history, setHistory] = useSyncedState('reagents_history', []); 

      const [searchTerm, setSearchTerm] = useState('');
      const [activeTab, setActiveTab] = useState('reagent');
      const [showAddModal, setShowAddModal] = useState(false);
      const [newReagent, setNewReagent] = useState({ type: 'reagent', usage: '' });
      const [showDeleteModal, setShowDeleteModal] = useState(false);
      const [itemToDelete, setItemToDelete] = useState(null);
      // NOVO: Estado para editar reagente
      const [showEditModal, setShowEditModal] = useState(false);
      const [editingReagent, setEditingReagent] = useState(null);
      // NOVO: Estado para Upload PDF
      const [showUploadPreview, setShowUploadPreview] = useState(false);
      const [extractedData, setExtractedData] = useState(null);
      const fileInputRef = useRef(null);

      // Listas de Sugestões para Autocomplete
      const suggestions = useMemo(() => {
         const names = new Set();
         const brands = new Set();
         const units = new Set();
         
         // Adiciona reagentes atuais
         reagents.forEach(r => {
             if(r.name) names.add(r.name);
             if(r.brand) brands.add(r.brand);
             if(r.unit) units.add(r.unit);
         });

         // Adiciona do PDF importado (se necessário)
         INITIAL_REAGENTS.forEach(r => {
             if(r.name) names.add(r.name);
             if(r.brand) brands.add(r.brand);
             if(r.unit) units.add(r.unit);
         });
         
         // Adiciona algumas unidades padrão se não existirem
         ['mg/L', 'µg/mL', 'mol/L', 'g/L', '%', 'µS/cm', 'pH', 'NTU'].forEach(u => units.add(u));

         return {
             names: Array.from(names).sort(),
             brands: Array.from(brands).sort(),
             units: Array.from(units).sort()
         };
      }, [reagents]);

      const normalizeName = (str) => str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : "";

      const getStatus = (dateStr) => {
        const today = new Date(); const expiry = new Date(dateStr); const diffTime = expiry.getTime() - today.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays < 0) return { color: 'text-red-500', bg: 'bg-red-500/10', border: 'border-red-500/20', label: 'VENCIDO' };
        if (diffDays < 30) return { color: 'text-yellow-400', bg: 'bg-yellow-500/10', border: 'border-yellow-500/20', label: 'VENCE EM BREVE' };
        return { color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', label: 'VALIDADE OK' };
      };

      const filteredList = useMemo(() => {
        let list = (Array.isArray(reagents) ? reagents : []).filter(r => (r.type === activeTab || (!r.type && activeTab === 'reagent')) && (normalizeName(r.name).includes(normalizeName(searchTerm)) || normalizeName(r.brand).includes(normalizeName(searchTerm))));
        list.sort((a, b) => new Date(a.expiryDate).getTime() - new Date(b.expiryDate).getTime());
        return list;
      }, [reagents, searchTerm, activeTab]);

      const historyList = useMemo(() => {
        let list = (Array.isArray(history) ? history : []).filter(h => normalizeName(h.name).includes(normalizeName(searchTerm)));
        list.sort((a, b) => new Date(b.removedDate).getTime() - new Date(a.removedDate).getTime());
        return list;
      }, [history, searchTerm]);

      const getSuggestionBadge = (item, list) => {
        if (activeTab === 'history') return null;
        const normItemName = normalizeName(item.name);
        const duplicates = list.filter(r => normalizeName(r.name) === normItemName);
        if (duplicates.length > 1) {
          duplicates.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
          const isFirst = duplicates[0].id === item.id;
          if (isFirst) {
            return (
              <span className="ml-2 inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-bold bg-blue-500 text-white animate-pulse">
                <Icons.CheckCircle size={10} /> USAR ESTE
              </span>
            );
          }
        }
        return null;
      };

      const calculateExpiry = (openingDate) => {
        if (!openingDate) return '';
        const date = new Date(openingDate);
        date.setFullYear(date.getFullYear() + 1);
        return date.toISOString().split('T')[0];
      };

      const handleAddReagent = (e) => {
        e.preventDefault(); if (!newReagent.name || !newReagent.expiryDate) return;
        const item = { 
          ...newReagent, 
          id: Date.now().toString(), 
          type: newReagent.type, 
          brand: newReagent.brand || 'N/A', 
          lot: newReagent.lot || 'N/A',
          usage: newReagent.type === 'standard' ? newReagent.standardType : (newReagent.usage || ''), // Lógica condicional para tipo
          concentration: newReagent.concentration || '',
          unit: newReagent.unit || '',
          openingDate: newReagent.openingDate || '',
          sc: newReagent.sc || '',
          arrivalDate: newReagent.arrivalDate || '',
          recovery: newReagent.recovery || '',
          reference: newReagent.reference || ''
        };
        setReagents([...reagents, item]); setShowAddModal(false); setNewReagent({ type: activeTab === 'standard' ? 'standard' : 'reagent', usage: '' });
      };

      const executeDelete = (reason) => {
        if (!itemToDelete) return;
        const historyItem = { ...itemToDelete, removedDate: new Date().toISOString(), removalReason: reason };
        setHistory([historyItem, ...history]); setReagents(reagents.filter(r => r.id !== itemToDelete.id)); setShowDeleteModal(false); setItemToDelete(null);
      };

      const deletePermanently = (id) => {
        if(confirm('Tem a certeza que deseja excluir permanentemente este item? Esta ação não pode ser desfeita.')) {
          setReagents(reagents.filter(r => r.id !== id));
        }
      };

      const deleteHistoryItem = (id) => {
        if(confirm('Tem a certeza que deseja excluir este registro do histórico?')) {
          setHistory(history.filter(h => h.id !== id));
        }
      };

      const openEditModal = (item) => {
        setEditingReagent({...item, standardType: item.usage }); // Mapeia usage de volta para standardType na edição se for padrão
        setShowEditModal(true);
      };

      const handleUpdateReagent = (e) => {
        e.preventDefault();
        if (!editingReagent.name || !editingReagent.expiryDate) return;
        
        // Atualiza o objeto, garantindo que se for padrão, usage recebe o valor do seletor
        const updatedItem = {
            ...editingReagent,
            usage: editingReagent.type === 'standard' ? editingReagent.standardType : editingReagent.usage
        };
        
        setReagents(prev => prev.map(r => r.id === updatedItem.id ? updatedItem : r));
        setShowEditModal(false);
        setEditingReagent(null);
      };

      return (
        <div className="min-h-screen bg-slate-900 text-slate-200 p-6 md:p-12">
            
          {/* DATALISTS PARA AUTOCOMPLETE */}
          <datalist id="nameSuggestions">
              {suggestions.names.map((name, i) => <option key={i} value={name} />)}
          </datalist>
          <datalist id="brandSuggestions">
              {suggestions.brands.map((brand, i) => <option key={i} value={brand} />)}
          </datalist>
          <datalist id="unitSuggestions">
              {suggestions.units.map((unit, i) => <option key={i} value={unit} />)}
          </datalist>

          <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div className="flex items-center gap-4"><button onClick={onBack} className="p-2 rounded-full hover:bg-slate-800 transition-colors"><Icons.ArrowLeft size={24} /></button><div><h2 className="text-3xl font-bold text-white flex items-center gap-3"><Icons.Beaker className="text-emerald-400" /> Reagentes & Padrões</h2><p className="text-slate-400 text-sm">Estoque sincronizado</p></div></div>
            <div className="flex bg-slate-800/50 p-1 rounded-xl border border-slate-700">{['reagent', 'standard', 'history'].map(tab => <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 rounded-lg text-sm font-medium ${activeTab === tab ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>{tab === 'history' ? 'Histórico' : (tab === 'reagent' ? 'Reagentes' : 'Padrões')}</button>)}</div>
            
            {/* BOTÕES DE AÇÃO - REMOVIDO UPLOAD PDF */}
            {activeTab !== 'history' && (
              <div className="flex gap-2">
                <button onClick={() => { setNewReagent({ type: activeTab }); setShowAddModal(true); }} className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-medium shadow-lg transition-all hover:scale-105"><Icons.Plus size={20} /> Novo Item</button>
              </div>
            )}
          </div>

          <div className="relative mb-8 max-w-2xl mx-auto"><Icons.Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20} /><input type="text" placeholder={`Buscar em ${activeTab}...`} className="w-full bg-slate-800/50 border border-slate-700 rounded-2xl py-4 pl-12 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500/50" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
          
          {activeTab !== 'history' ? (
            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
              {filteredList.map((item) => { const status = getStatus(item.expiryDate); return (
                <div key={item.id} className={`relative flex flex-col p-6 rounded-2xl bg-slate-800/40 border ${status.border} backdrop-blur-sm group`}>
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <h3 className="text-xl font-bold text-white flex items-center flex-wrap gap-2">{item.name}{getSuggestionBadge(item, filteredList)}</h3>
                      <p className="text-sm text-slate-400">{item.brand} • Lote: {item.lot}</p>
                      {item.type === 'standard' && (
                         <div className="text-xs text-blue-300 mt-1 font-mono flex flex-col gap-1">
                             <p>{item.concentration} {item.unit}</p>
                             {(item.reference || item.sc) && <p className="text-[10px] text-slate-500">Ref: {item.reference} | SC: {item.sc}</p>}
                         </div>
                      )}
                    </div>
                    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                      <button onClick={() => openEditModal(item)} className="text-slate-400 hover:text-blue-400 bg-slate-900/50 p-2 rounded-lg" title="Editar"><Icons.Pencil size={18} /></button>
                      <button onClick={() => { setItemToDelete(item); setShowDeleteModal(true); }} className="text-slate-400 hover:text-purple-400 bg-slate-900/50 p-2 rounded-lg" title="Dar Baixa (Arquivar)"><Icons.Archive size={18} /></button>
                      <button onClick={() => deletePermanently(item.id)} className="text-slate-400 hover:text-red-400 bg-slate-900/50 p-2 rounded-lg" title="Excluir Permanentemente"><Icons.Trash2 size={18} /></button>
                    </div>
                  </div>
                  {item.usage && <div className="mb-2 bg-slate-900/50 p-2 rounded-lg text-xs text-slate-300"><span className="font-semibold text-slate-500 uppercase tracking-wider text-[10px]">Uso:</span> {item.usage}</div>}
                  {item.type === 'standard' && item.openingDate && <div className="mb-4 flex items-center gap-2 text-xs text-blue-300 bg-blue-500/10 p-2 rounded-lg border border-blue-500/20"><Icons.FolderOpen size={14}/> Aberto em: {new Date(item.openingDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</div>}
                  <div className="mt-auto flex items-center justify-between pt-4 border-t border-slate-700/50"><div className="flex items-center gap-2 text-sm"><Icons.Calendar size={16} className="text-slate-500" /><span className="font-mono text-slate-200">{new Date(item.expiryDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</span></div><span className={`text-xs font-bold px-3 py-1 rounded-full ${status.bg} ${status.color}`}>{status.label}</span></div>
                </div>
              );})}
            </div>
          ) : (
            <div className="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-xl">
              <div className="overflow-x-auto">
                <table className="w-full text-left text-sm text-slate-300">
                  <thead className="bg-slate-900/50 uppercase text-slate-400 font-medium"><tr><th className="px-6 py-4">Item</th><th className="px-6 py-4">Marca/Lote</th><th className="px-6 py-4">Motivo</th><th className="px-6 py-4">Data Baixa</th><th className="px-6 py-4 text-right">Ação</th></tr></thead>
                  <tbody className="divide-y divide-slate-700">
                    {historyList.map(i => (
                      <tr key={i.id} className="hover:bg-slate-700/30">
                        <td className="px-6 py-4 font-medium text-white">{i.name}</td>
                        <td className="px-6 py-4">{i.brand} - {i.lot}</td>
                        <td className="px-6 py-4"><span className={`inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs font-bold ${i.removalReason === 'Acabou' ? 'bg-purple-500/20 text-purple-300' : 'bg-red-500/20 text-red-300'}`}>{i.removalReason}</span></td>
                        <td className="px-6 py-4 font-mono text-slate-400">{new Date(i.removedDate).toLocaleDateString('pt-BR')}</td>
                        <td className="px-6 py-4 text-right">
                          <button onClick={() => deleteHistoryItem(i.id)} className="text-slate-500 hover:text-red-400 p-1.5 hover:bg-slate-700 rounded transition-colors"><Icons.Trash2 size={16}/></button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* MODAL ADICIONAR */}
          {showAddModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4"><div className="bg-slate-800 border border-slate-700 w-full max-w-lg rounded-2xl shadow-2xl p-6"><h3 className="text-xl font-bold text-white mb-4">Novo Item</h3><form onSubmit={handleAddReagent} className="space-y-4"><div className="flex gap-4"><label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="type" checked={newReagent.type === 'reagent'} onChange={() => setNewReagent({...newReagent, type: 'reagent'})} className="accent-emerald-500" /><span className="text-slate-300">Reagente</span></label><label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="type" checked={newReagent.type === 'standard'} onChange={() => setNewReagent({...newReagent, type: 'standard'})} className="accent-blue-500" /><span className="text-slate-300">Padrão</span></label></div>
          
          <input required list="nameSuggestions" className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.name || ''} onChange={e => setNewReagent({...newReagent, name: e.target.value})} placeholder="Nome (Ex: Fósforo)" />
          
          {newReagent.type === 'standard' && (
            <div className="space-y-4 bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                <div className="grid grid-cols-2 gap-4">
                    <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.concentration || ''} onChange={e => setNewReagent({...newReagent, concentration: e.target.value})} placeholder="Concentração" />
                    <input list="unitSuggestions" className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.unit || ''} onChange={e => setNewReagent({...newReagent, unit: e.target.value})} placeholder="Unidade" />
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.sc || ''} onChange={e => setNewReagent({...newReagent, sc: e.target.value})} placeholder="Cód. SC" />
                    <input type="date" className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-xs" value={newReagent.arrivalDate || ''} onChange={e => setNewReagent({...newReagent, arrivalDate: e.target.value})} title="Data de Chegada" />
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.recovery || ''} onChange={e => setNewReagent({...newReagent, recovery: e.target.value})} placeholder="REC %" />
                    <select className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.reference || ''} onChange={e => setNewReagent({...newReagent, reference: e.target.value})}>
                        <option value="" disabled>Referência...</option>
                        <option value="NIST">NIST</option>
                        <option value="ISOGUIA">ISOGUIA</option>
                    </select>
                </div>
            </div>
          )}

          <div className="grid grid-cols-2 gap-4">
              <input list="brandSuggestions" className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.brand || ''} onChange={e => setNewReagent({...newReagent, brand: e.target.value})} placeholder="Marca" />
              <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.lot || ''} onChange={e => setNewReagent({...newReagent, lot: e.target.value})} placeholder="Lote" />
          </div>
          
          {/* LÓGICA CONDICIONAL DE USO / TIPO DE PADRÃO */}
          {newReagent.type === 'standard' ? (
             <div className="w-full">
                 <label className="block text-xs text-slate-400 mb-1">Tipo de Padrão</label>
                 <select 
                   className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500"
                   value={newReagent.standardType || ''} 
                   onChange={e => setNewReagent({...newReagent, standardType: e.target.value})}
                 >
                    <option value="" disabled>Selecione...</option>
                    <option value="Verificação">Verificação</option>
                    <option value="Calibração">Calibração</option>
                    <option value="Curva">Curva</option>
                 </select>
             </div>
          ) : (
             <input className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.usage || ''} onChange={e => setNewReagent({...newReagent, usage: e.target.value})} placeholder="Uso (Opcional)" />
          )}

          <div className="grid grid-cols-2 gap-4">
            {newReagent.type === 'standard' && <div><label className="text-xs text-blue-400">Abertura</label><input type="date" className="w-full bg-slate-900 border border-blue-500/50 rounded-lg p-3 text-white" value={newReagent.openingDate || ''} onChange={e => setNewReagent({...newReagent, openingDate: e.target.value})} /></div>}
            <div><label className="text-xs text-slate-400">Validade</label><div className="flex gap-2"><input required type="date" className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.expiryDate || ''} onChange={e => setNewReagent({...newReagent, expiryDate: e.target.value})} />{newReagent.type === 'standard' && <button type="button" onClick={() => setNewReagent({...newReagent, expiryDate: calculateExpiry(newReagent.openingDate)})} className="bg-blue-600/20 text-blue-400 p-2 rounded-lg hover:bg-blue-600/40" title="1 Ano após Abertura"><Icons.Calculator size={20}/></button>}</div></div>
          </div>
          <div className="flex gap-3 pt-4"><button type="button" onClick={() => setShowAddModal(false)} className="flex-1 py-3 text-slate-400 hover:bg-slate-700 rounded-lg">Cancelar</button><button type="submit" className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold">Salvar</button></div></form></div></div>}
          
          {/* MODAL EDITAR */}
          {showEditModal && editingReagent && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
              <div className="bg-slate-800 border border-slate-700 w-full max-w-lg rounded-2xl shadow-2xl p-6">
                <h3 className="text-xl font-bold text-white mb-4">Editar Item</h3>
                <form onSubmit={handleUpdateReagent} className="space-y-4">
                  <input required list="nameSuggestions" className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.name || ''} onChange={e => setEditingReagent({...editingReagent, name: e.target.value})} placeholder="Nome" />
                  
                  {editingReagent.type === 'standard' && (
                    <div className="space-y-4 bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                        <div className="grid grid-cols-2 gap-4">
                            <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.concentration || ''} onChange={e => setEditingReagent({...editingReagent, concentration: e.target.value})} placeholder="Conc." />
                            <input list="unitSuggestions" className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.unit || ''} onChange={e => setEditingReagent({...editingReagent, unit: e.target.value})} placeholder="Unid." />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.sc || ''} onChange={e => setEditingReagent({...editingReagent, sc: e.target.value})} placeholder="Cód. SC" />
                            <input type="date" className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-xs" value={editingReagent.arrivalDate || ''} onChange={e => setEditingReagent({...editingReagent, arrivalDate: e.target.value})} title="Chegou" />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.recovery || ''} onChange={e => setEditingReagent({...editingReagent, recovery: e.target.value})} placeholder="REC %" />
                            <select className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.reference || ''} onChange={e => setEditingReagent({...editingReagent, reference: e.target.value})}>
                                <option value="" disabled>Ref...</option>
                                <option value="NIST">NIST</option>
                                <option value="ISOGUIA">ISOGUIA</option>
                            </select>
                        </div>
                    </div>
                  )}

                  <div className="grid grid-cols-2 gap-4">
                      <input list="brandSuggestions" className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.brand || ''} onChange={e => setEditingReagent({...editingReagent, brand: e.target.value})} placeholder="Marca" />
                      <input className="bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.lot || ''} onChange={e => setEditingReagent({...editingReagent, lot: e.target.value})} placeholder="Lote" />
                  </div>

                  {/* LÓGICA CONDICIONAL DE USO / TIPO DE PADRÃO NO EDITAR */}
                  {editingReagent.type === 'standard' ? (
                     <div className="w-full">
                         <label className="block text-xs text-slate-400 mb-1">Tipo de Padrão</label>
                         <select 
                           className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500"
                           value={editingReagent.standardType || ''} 
                           onChange={e => setEditingReagent({...editingReagent, standardType: e.target.value})}
                         >
                            <option value="" disabled>Selecione...</option>
                            <option value="Verificação">Verificação</option>
                            <option value="Calibração">Calibração</option>
                            <option value="Curva">Curva</option>
                         </select>
                     </div>
                  ) : (
                     <input className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.usage || ''} onChange={e => setEditingReagent({...editingReagent, usage: e.target.value})} placeholder="Uso (Opcional)" />
                  )}

                  <div className="grid grid-cols-2 gap-4">
                    {editingReagent.type === 'standard' && <div><label className="text-xs text-blue-400">Abertura</label><input type="date" className="w-full bg-slate-900 border border-blue-500/50 rounded-lg p-3 text-white" value={editingReagent.openingDate || ''} onChange={e => setEditingReagent({...editingReagent, openingDate: e.target.value})} /></div>}
                    <div>
                      <label className="text-xs text-slate-400">Validade</label>
                      <div className="flex gap-2">
                        <input required type="date" className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.expiryDate || ''} onChange={e => setEditingReagent({...editingReagent, expiryDate: e.target.value})} />
                         {/* BOTÃO 1 ANO EDIT */}
                         {editingReagent.type === 'standard' && <button type="button" onClick={() => setEditingReagent({...editingReagent, expiryDate: calculateExpiry(editingReagent.openingDate)})} className="bg-blue-600/20 text-blue-400 p-2 rounded-lg hover:bg-blue-600/40" title="1 Ano após Abertura"><Icons.Calculator size={20}/></button>}
                      </div>
                    </div>
                  </div>
                  <div className="flex gap-3 pt-4"><button type="button" onClick={() => {setShowEditModal(false); setEditingReagent(null);}} className="flex-1 py-3 text-slate-400 hover:bg-slate-700 rounded-lg">Cancelar</button><button type="submit" className="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">Salvar Alterações</button></div>
                </form>
              </div>
            </div>
          )}

          {/* MODAL DAR BAIXA */}
          {showDeleteModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"><div className="bg-slate-800 border border-slate-600 w-full max-w-md rounded-2xl shadow-2xl p-6 text-center"><div className="bg-slate-700 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Archive size={32} className="text-slate-300" /></div><h3 className="text-xl font-bold text-white mb-2">Dar Baixa no Item?</h3><div className="flex flex-col gap-3 mt-6"><button onClick={() => executeDelete('Acabou')} className="w-full py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-xl font-medium flex items-center justify-center gap-2"><Icons.CheckCircle size={18} /> Acabou</button><button onClick={() => executeDelete('Venceu/Descarte')} className="w-full py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl font-medium flex items-center justify-center gap-2"><Icons.Trash2 size={18} /> Venceu/Descarte</button><button onClick={() => setShowDeleteModal(false)} className="w-full py-3 text-slate-400 hover:text-white mt-2">Cancelar</button></div></div></div>}
        </div>
      );
    }

    function ArmyControlledManager({ onBack }) {
      const [armyReagents, setArmyReagents] = useSyncedState('army', INITIAL_ARMY_REAGENTS); // Hook Sync
      const [selectedMonth, setSelectedMonth] = useState('Novembro');
      const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
      const [showAddModal, setShowAddModal] = useState(false);
      const [newReagent, setNewReagent] = useState({});
      const [showEditModal, setShowEditModal] = useState(false);
      const [editingReagent, setEditingReagent] = useState(null);
      const LAB_UNITS = ['mL', 'L', 'µL', 'g', 'kg', 'mg', 'und', 'fr', 'cx', 'gal'];
      const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

      const handleQuantityChange = (id, newQty) => setArmyReagents(prev => prev.map(r => r.id === id ? { ...r, quantity: newQty } : r));
      const handleUnitChange = (id, newUnit) => setArmyReagents(prev => prev.map(r => r.id === id ? { ...r, unit: newUnit } : r));
      const handleAddReagent = (e) => { e.preventDefault(); if (!newReagent.name) return; const item = { id: 'army_' + Date.now(), name: newReagent.name, quantity: Number(newReagent.quantity) || 0, unit: newReagent.unit || 'mL' }; setArmyReagents([...armyReagents, item]); setShowAddModal(false); setNewReagent({}); };
      const handleUpdateReagent = (e) => { e.preventDefault(); if (!editingReagent.name) return; setArmyReagents(prev => prev.map(r => r.id === editingReagent.id ? editingReagent : r)); setShowEditModal(false); setEditingReagent(null); };
      const removeReagent = (id) => { if(confirm('Remover este item?')) setArmyReagents(prev => prev.filter(r => r.id !== id)); };

      return (
        <div className="min-h-screen bg-slate-900 text-slate-200 p-6 md:p-12 print:bg-white print:text-black print:p-0">
          <div className="no-print">
            <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4"><div className="flex items-center gap-4"><button onClick={onBack} className="p-2 rounded-full hover:bg-slate-800 transition-colors"><Icons.ArrowLeft size={24} /></button><div><h2 className="text-3xl font-bold text-white flex items-center gap-3"><Icons.ShieldAlert className="text-red-500" /> Controle Exército</h2><p className="text-slate-400 text-sm">Sincronizado</p></div></div><div className="flex flex-wrap items-center gap-3 bg-slate-800/50 p-2 rounded-xl border border-slate-700">
                <select value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-red-500 cursor-pointer">
                  {months.map(m => <option key={m} value={m}>{m}</option>)}
                </select>
                <input type="number" value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)} className="w-24 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-red-500" placeholder="Ano" />
                
                <div className="w-px h-6 bg-slate-600 mx-2"></div>
                <button onClick={() => setShowAddModal(true)} className="bg-slate-700 text-slate-200 px-3 py-2 rounded-lg font-medium hover:bg-slate-600 transition-colors flex items-center gap-2 text-sm"><Icons.Plus size={16} /> Adicionar Item</button>
                <button onClick={()=>window.print()} className="bg-slate-100 text-slate-900 px-4 py-2 rounded-lg font-bold hover:bg-white transition-colors flex items-center gap-2"><Icons.Printer size={18} /> Exportar PDF</button>
              </div></div>
            <div className="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-xl"><div className="overflow-x-auto"><table className="w-full text-left text-sm text-slate-300"><thead className="bg-slate-900/50 uppercase text-slate-400 font-medium"><tr><th className="px-6 py-4">Reagente</th><th className="px-6 py-4 text-center">Quantidade</th><th className="px-6 py-4 text-center">Unidade</th><th className="px-6 py-4 text-right w-24">Ações</th></tr></thead><tbody className="divide-y divide-slate-700">{armyReagents.map((item) => (<tr key={item.id} className="group hover:bg-slate-700/30 transition-colors"><td className="px-6 py-4 font-medium text-white">{item.name}</td><td className="px-6 py-4 text-center"><input type="number" min="0" value={item.quantity} onChange={(e) => handleQuantityChange(item.id, Number(e.target.value))} className="w-24 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-center text-white focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500" /></td><td className="px-6 py-4 text-center"><select value={item.unit} onChange={(e) => handleUnitChange(item.id, e.target.value)} className="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-center text-white appearance-none cursor-pointer hover:bg-slate-800">{LAB_UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select></td><td className="px-6 py-4 text-right"><div className="flex justify-end gap-2"><button onClick={() => { setEditingReagent({...item}); setShowEditModal(true); }} className="p-2 text-slate-600 hover:text-blue-400"><Icons.Pencil size={16} /></button><button onClick={() => removeReagent(item.id)} className="p-2 text-slate-600 hover:text-red-400"><Icons.Trash2 size={16} /></button></div></td></tr>))}</tbody></table></div></div>
          </div>
          <div className="print-only print-container">
            <h1 className="text-xl font-bold uppercase text-center mb-2">Movimentação de Reagentes Controlados Pelo Exército</h1>
            <div className="text-center text-sm mb-6 pb-2 border-b-2 border-black"><span className="font-bold">Mês de Referência:</span> {selectedMonth} / {selectedYear}</div>
            <table className="print-table"><thead><tr><th style={{ width: '60%' }}>REAGENTES</th><th style={{ width: '25%' }}>Qtd em uso no Laboratório</th><th style={{ width: '15%' }}>UNIDADE</th></tr></thead><tbody>{armyReagents.map(item => (<tr key={item.id}><td>{item.name}</td><td className="text-center">{item.quantity}</td><td className="text-center">{item.unit}</td></tr>))}</tbody></table>
            <div className="signature-block"><div className="signature-line">Assinatura do Responsável Técnico</div><div className="signature-line">Data</div></div>
          </div>

          {showAddModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 no-print"><div className="bg-slate-800 border border-slate-700 w-full max-w-lg rounded-2xl shadow-2xl p-6"><h3 className="text-xl font-bold text-white flex items-center gap-2">Adicionar Controlado</h3><form onSubmit={handleAddReagent} className="p-6 space-y-4"><input required className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.name || ''} onChange={e => setNewReagent({...newReagent, name: e.target.value})} placeholder="Nome" /><div className="grid grid-cols-2 gap-4"><input type="number" className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.quantity || ''} onChange={e => setNewReagent({...newReagent, quantity: e.target.value})} placeholder="Qtd" /><select className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={newReagent.unit || 'mL'} onChange={e => setNewReagent({...newReagent, unit: e.target.value})}>{LAB_UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select></div><div className="flex gap-3 pt-4"><button type="button" onClick={() => setShowAddModal(false)} className="flex-1 py-3 text-slate-400">Cancelar</button><button type="submit" className="flex-1 py-3 bg-red-600 text-white rounded-lg font-bold">Adicionar</button></div></form></div></div>}
          {showEditModal && editingReagent && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 no-print"><div className="bg-slate-800 border border-slate-700 w-full max-w-lg rounded-2xl shadow-2xl p-6"><h3 className="text-xl font-bold text-white">Editar</h3><form onSubmit={handleUpdateReagent} className="p-6 space-y-4"><input required className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.name || ''} onChange={e => setEditingReagent({...editingReagent, name: e.target.value})} /><div className="grid grid-cols-2 gap-4"><input type="number" className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.quantity} onChange={e => setEditingReagent({...editingReagent, quantity: Number(e.target.value)})} /><select className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white" value={editingReagent.unit} onChange={e => setEditingReagent({...editingReagent, unit: e.target.value})}>{LAB_UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select></div><div className="flex gap-3 pt-4"><button type="button" onClick={() => {setShowEditModal(false); setEditingReagent(null);}} className="flex-1 py-3 text-slate-400">Cancelar</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold">Salvar</button></div></form></div></div>}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<QGIDashboard />);
  </script>
</body>
</html>